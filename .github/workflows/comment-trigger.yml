name: Comment Triggered Pipeline

on:
  issue_comment:
    types: [created]
  workflow_dispatch: {}

jobs:
  run-pipeline-on-command:
    runs-on: ubuntu-latest
    # Only run when triggered manually (workflow_dispatch) OR when the comment is on a PR,
    # contains the /run-pipeline command, and the commenter is a repo owner/member/collaborator.
    if: >-
      (github.event_name == 'workflow_dispatch') || (
        github.event.issue.pull_request != null &&
        contains(github.event.comment.body, '/run-pipeline') &&
        (
          github.event.comment.author_association == 'OWNER' ||
          github.event.comment.author_association == 'MEMBER' ||
          github.event.comment.author_association == 'COLLABORATOR'
        )
      )
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run pipeline
        env:
          HUGGINGFACE_API_KEY: ${{ secrets.HUGGINGFACE_API_KEY }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          python pipeline/run.py --topics topics.yaml --since 48

      - name: Upload outputs as artifacts
        uses: actions/upload-artifact@v4
        with:
          name: newsgenerator-output
          path: |
            outbox/**
            content/**
